# core-manifest.yaml v3
#
# 動線ベースの Layer アーキテクチャ
#
# ═══════════════════════════════════════════════════════════════════
# 設計原則: 全コンポーネントは「動線単位」で扱う
# ═══════════════════════════════════════════════════════════════════
#
# 黄金動線:
#   計画動線: ユーザー要求 → pm → playbook → state.md
#   実行動線: playbook → Edit/Write → Guard発火
#   検証動線: /crit → critic → done_criteria検証
#   完了動線: phase完了 → アーカイブ → 次タスク導出
#
# Layer分類（動線単位）:
#   Core: 計画動線 + 検証動線（ないと破綻）
#   Quality: 実行動線（ないと品質低下）
#   Extension: 完了動線 + 共通基盤（手動代替可）
#
# ═══════════════════════════════════════════════════════════════════

version: 3
frozen_at: "2025-12-20"
upgraded_from: 2

# ────────────────────────────────────────────────────────────────
# 変更ポリシー
# ────────────────────────────────────────────────────────────────
policy:
  golden_rule: "全コンポーネントは動線単位で扱う"
  no_new_components: true
  allow_changes:
    - bugfix
    - deletion
    - test_improvement
  forbid_changes:
    - new_hook_without_review
    - new_subagent_without_review
    - new_skill_without_review

# ════════════════════════════════════════════════════════════════
# CORE LAYER（計画動線 + 検証動線）
# ════════════════════════════════════════════════════════════════
#
# これがないとシステムが破綻する。
# 変更は凍結（HARD_BLOCK レベル）。
#
core:
  description: |
    計画動線と検証動線のコンポーネント。
    ないとシステムが破綻する。凍結対象。

  # ────────────────────────────────────────────────────────────────
  # 計画動線（6コンポーネント）
  # ────────────────────────────────────────────────────────────────
  # フロー: ユーザープロンプト → prompt-guard → /task-start → pm → state → playbook完成
  #
  planning_flow:
    description: "ユーザー要求 → playbook 作成までの動線"
    criticality: "ないと playbook なし → 破綻"

    components:
      - name: prompt-guard.sh
        type: hook
        trigger: UserPromptSubmit
        role: タスク検出、pm 必須警告
        why_core: "タスク要求を検出し pm を強制する入口"

      - name: task-start.md
        type: command
        role: 計画動線の起点コマンド
        why_core: "project.md から playbook を導出する唯一の正規ルート"

      - name: pm.md
        type: subagent
        role: playbook 作成
        why_core: "playbook を作成できる唯一の存在"

      - name: state
        type: skill
        role: state.md 管理
        why_core: "state.md の更新ロジックを集約"

      - name: plan-management
        type: skill
        role: playbook 運用ガイド
        why_core: "playbook 作成時のルール適用"

      - name: playbook-init.md
        type: command
        role: playbook 直接作成（旧互換）
        why_core: "/task-start へのエイリアス、互換性維持"

  # ────────────────────────────────────────────────────────────────
  # 検証動線（5コンポーネント）
  # ────────────────────────────────────────────────────────────────
  # フロー: Phase完了宣言 → /crit → critic → critic-guard → PASS/FAIL判定
  #
  verification_flow:
    description: "done_criteria 検証の動線"
    criticality: "ないと報酬詐欺可能 → 破綻"

    components:
      - name: crit.md
        type: command
        role: 検証起点コマンド
        why_core: "critic を呼び出す唯一の正規ルート"

      - name: critic.md
        type: subagent
        role: done_criteria 検証
        why_core: "done_criteria を検証できる唯一の存在"

      - name: critic-guard.sh
        type: hook
        trigger: PostToolUse
        role: critic PASS 必須
        why_core: "phase 完了時に critic を強制"

      - name: test
        type: skill
        role: test_command 実行
        why_core: "done_criteria の test_command を実行"

      - name: lint
        type: skill
        role: state/playbook 整合性チェック
        why_core: "構造的整合性を検証"

# ════════════════════════════════════════════════════════════════
# QUALITY LAYER（実行動線）
# ════════════════════════════════════════════════════════════════
#
# これがないと品質低下するが、動作はする。
# 変更は保護（レビュー必須）。
#
quality:
  description: |
    実行動線のコンポーネント。
    ないと品質低下するが、動作はする。保護対象。

  # ────────────────────────────────────────────────────────────────
  # 実行動線（10コンポーネント）
  # ────────────────────────────────────────────────────────────────
  # フロー: playbook読込 → ガード群 → Edit/Write → subtask-guard → validations
  #
  execution_flow:
    description: "playbook に基づく実行の動線"
    criticality: "ないと品質低下、ただし動作はする"

    components:
      - name: init-guard.sh
        type: hook
        trigger: PreToolUse
        role: 必須ファイル Read 強制
        why_quality: "state.md/playbook の Read を強制"

      - name: playbook-guard.sh
        type: hook
        trigger: PreToolUse:Edit,Write
        role: playbook 存在チェック
        why_quality: "playbook=null で Edit/Write をブロック"

      - name: subtask-guard.sh
        type: hook
        trigger: PreToolUse:Edit
        role: 3観点検証（technical/consistency/completeness）
        why_quality: "subtask 完了時の検証を強制"

      - name: scope-guard.sh
        type: hook
        trigger: PreToolUse:Edit
        role: done_criteria 変更検出
        why_quality: "スコープクリープを防止"

      - name: check-protected-edit.sh
        type: hook
        trigger: PreToolUse:Edit
        role: HARD_BLOCK ファイル保護
        why_quality: "CLAUDE.md 等の編集を防止"

      - name: pre-bash-check.sh
        type: hook
        trigger: PreToolUse:Bash
        role: 危険コマンドブロック
        why_quality: "rm -rf 等をブロック"

      - name: consent-guard.sh
        type: hook
        trigger: PreToolUse
        role: 危険操作同意取得
        why_quality: "破壊的操作前にユーザー確認"

      - name: check-main-branch.sh
        type: hook
        trigger: PreToolUse:Edit,Write
        role: main ブランチ保護
        why_quality: "main での直接編集を防止"

      - name: lint-checker
        type: skill
        role: 静的解析
        why_quality: "コード品質を保証"

      - name: test-runner
        type: skill
        role: テスト実行
        why_quality: "テスト通過を保証"

# ════════════════════════════════════════════════════════════════
# EXTENSION LAYER（完了動線 + 共通基盤 + 横断的）
# ════════════════════════════════════════════════════════════════
#
# 手動で代替可能。あると便利。
# 変更は柔軟（自由に追加・削除可）。
#
extension:
  description: |
    完了動線、共通基盤、横断的整合性のコンポーネント。
    手動で代替可能。あると便利。

  # ────────────────────────────────────────────────────────────────
  # 完了動線（7コンポーネント）
  # ────────────────────────────────────────────────────────────────
  completion_flow:
    description: "phase 完了 → 次タスクの動線"
    criticality: "手動で代替可能"

    components:
      - name: archive-playbook.sh
        type: hook
        role: playbook アーカイブ

      - name: cleanup-hook.sh
        type: hook
        role: tmp/ クリーンアップ

      - name: create-pr-hook.sh
        type: hook
        role: PR 作成

      - name: post-loop
        type: skill
        role: 完了後処理

      - name: context-management
        type: skill
        role: コンテキスト管理

      - name: rollback.md
        type: command
        role: Git ロールバック

      - name: state-rollback.md
        type: command
        role: state.md ロールバック

  # ────────────────────────────────────────────────────────────────
  # 共通基盤（5コンポーネント）
  # ────────────────────────────────────────────────────────────────
  common:
    description: "セッションライフサイクル管理"
    criticality: "状態把握に便利だが必須ではない"

    components:
      - name: session-start.sh
        type: hook
        trigger: SessionStart
        role: セッション初期化

      - name: session-end.sh
        type: hook
        trigger: SessionEnd
        role: セッション終了処理

      - name: pre-compact.sh
        type: hook
        role: コンパクト前処理

      - name: stop-summary.sh
        type: hook
        role: 中断時サマリー

      - name: log-subagent.sh
        type: hook
        role: SubAgent ログ

  # ────────────────────────────────────────────────────────────────
  # 横断的整合性（3コンポーネント）
  # ────────────────────────────────────────────────────────────────
  cross_cutting:
    description: "動線間の整合性保証"
    criticality: "整合性リスクあるが動作はする"

    components:
      - name: check-coherence.sh
        type: hook
        role: focus/playbook/branch 整合性

      - name: depends-check.sh
        type: hook
        role: playbook 間依存関係

      - name: executor-guard.sh
        type: hook
        role: executor 制御

# ════════════════════════════════════════════════════════════════
# 削除候補
# ════════════════════════════════════════════════════════════════
deletion_candidates:
  hooks:
    - audit-unused.sh
    - check-integrity.sh
    - check-spec-sync.sh
    - create-pr.sh
    - failure-logger.sh
    - generate-repository-map.sh
    - merge-pr.sh
    - playbook-validator.sh
    - role-resolver.sh
    - system-health-check.sh
    - test-done-criteria.sh
    - test-hooks.sh

  subagents:
    - codex-delegate.md
    - health-checker.md
    - setup-guide.md

# ════════════════════════════════════════════════════════════════
# SUMMARY
# ════════════════════════════════════════════════════════════════
#
# Core Layer:
#   計画動線: 6 components (prompt-guard, task-start, pm, state, plan-management, playbook-init)
#   検証動線: 5 components (crit, critic, critic-guard, test, lint)
#   合計: 11 components
#
# Quality Layer:
#   実行動線: 10 components
#
# Extension Layer:
#   完了動線: 7 components
#   共通基盤: 5 components
#   横断的: 3 components
#   合計: 15 components
#
# 総計: 36 components (動線ベースで再分類)
#
